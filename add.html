<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<link rel="stylesheet" href="style.css">

	<title>MyBox</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript">
	</script>

	<script src="jquery.min.js"></script>
	<!-- <script src="instascan.min.js"></script> -->
	<script src="html5-qrcode.min.js"></script>


	<script type="text/javascript" language="javascript">
		var mqtt;
		var reconnectTimeout = 2000;
		var host = "broker.hivemq.com";
		var port = 8000;


		window.addEventListener('load', () => {
            // const queryString = window.location.search;
            // const params = new URLSearchParams(queryString);
			const params = (new URL(document.location)).searchParams;
			const name = params.get('name');
			const resi = params.get('resi');

			// const name = localStorage.getItem('NAME');
			document.getElementById('name').innerHTML = name;
			document.getElementById('resi').innerHTML = resi;
		})


		function confirmInfo() {
			
			setTimeout(function () {
				// window.location.href = "index.html";
                window.location.replace("index.html");
                window.history.pushState(null, "", window.location.href);
                window.onpopstate = function () {
                    window.history.pushState(null, "", window.location.href);
                };
			}, 7000); 

		}
		function onOpen() {
            // Once a connection has been made, make a subscription and send a message.
			const params = (new URL(document.location)).searchParams;
            const name = params.get('name');
            const key = params.get('key');
            var code = params.get('resi');
            if(code.toUpperCase() == "CLEAR" || code.toUpperCase() == "LIST"){
                code =  code.toLocaleUpperCase();
            }
            else{
                code = code.substring(code.length - 5, code.length);
                code= "add "+code;
            }
            console.log(code);
			
			mqtt.subscribe("BokuBox/courier/" + name);
			message = new Paho.MQTT.Message(key+" "+code);
			message.destinationName = "BokuBox/courier/" + name;
			mqtt.send(message);

           
            
		}

		function onFailure(message) {
			console.log("Connection Attempt to Host " + host + "Failed");
			setTimeout(MQTTconnect, reconnectTimeout);
		}


		function onMessageArrived(msg) {
			out_msg = msg.payloadString;
            if (out_msg.includes("Address")) {
                document.getElementById("sub").innerHTML = "Conneted";
            }
			else if (out_msg.includes("List Add")) {
				document.getElementById("sub").innerHTML = "Successfully";
				document.getElementById("sub").style.color = "#04AA6D";
                confirmInfo();
			}
			else if (out_msg.includes("List Full")) {
                document.getElementById("sub").innerHTML = out_msg;
				document.getElementById("sub").style.color = "#e80000";
                confirmInfo();
			}
			else if (out_msg.includes("List")) {
                document.getElementById("sub").innerHTML = out_msg;
				document.getElementById("sub").style.color = "#868788";
				document.getElementById("sub").style.fontSize = "12px";
                confirmInfo();
			}
            
		}

		function onConnect() {
			// Once a connection has been made, make a subscription and send a message.
			// readDevID();
			const params = (new URL(document.location)).searchParams;
			const name = params.get('name');
            const key = params.get('key');
			const resi = params.get('resi');
			// const name = localStorage.getItem('NAME');
			// var devID = document.getElementById("devID").value;
			console.log("Connected to " + name);
			mqtt.subscribe("BokuBox/courier/" + name);
			message = new Paho.MQTT.Message("courier ping");
			message.destinationName = "BokuBox/courier/" + name;
			message.retained = false;
			mqtt.send(message);
    
		}


		function MQTTconnect() {
			console.log("connecting to " + host + " " + port);
			var x = Math.floor(Math.random() * 10000);
			var cname = "orderform-" + x;
			mqtt = new Paho.MQTT.Client(host, port, cname);
			//document.write("connecting to "+ host);
			var options = {
				timeout: 3,
				onSuccess: onConnect,
				onFailure: onFailure,
			};
			mqtt.onMessageArrived = onMessageArrived

			mqtt.connect(options); //connect
		}


	</script>

  
</head>

<body>

  <head>
    <title>Slide Navbar</title>
    <link rel="stylesheet" type="text/css" href="slide navbar style.css">
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500&display=swap" rel="stylesheet">
  </head>


  <div class="main">
    <div class=" signup">
        <label for="chk" aria-hidden="true">MyBox</label>
        <label type="text" id="name" name="name" placeholder="Box ID"></label>
        <label type="text" id="key" name="key" placeholder="Key"></label>
        <label type="text" id="resi" name="resi" placeholder="No. Resi"></label>
        <label class="info" id="sub">Connecting... </label>
        <div>            
            <button type="button" onclick="onOpen();">Add</button>
        </div>
    </div>

  </div>

<script>
		MQTTconnect();
</script>

</body>

</html>